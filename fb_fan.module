<?php

/**
 * @file
 * Facebook Fan module.
 */

/**
 * Implements hook_help().
 */
function fb_fan_help($path, $arg) {
  switch ($path) {
    case 'admin/help#fb_fan':
      return nl2br(file_get_contents(dirname(__FILE__) . '/README.txt'));
    case FB_PATH_ADMIN . '/fb_fan/list':
      return '<p>' . t('Fan Boxes here are also listed on !blocks_page. Enable them from there!', array(
        '!blocks_page' => l(t('blocks page'), 'admin/structure/block'),
      )) . '</p>';
    case FB_PATH_ADMIN . '/fb_fan/create':
      return '<p>' . t('The most important field here is Profile ID which is the id of your Page in Facebook. If your page url is http://www.facebook.com/EXAMPLE, then go to https://graph.facebook.com/EXAMPLE. If you have the correct url, there should be line id. Copy that number to "Profile ID" field.') . '</p>';
  }
}

/**
 * Implements of hook_permission().
 *
 * Create 2 perms for display advice message and configure advice message.
 */
function fb_fan_permission() {
  return array(
    'administer fb_fan settings' => array(
      'title' => t('Administer fb_fan settings'),
    ),
  );
}

/**
 * Implements of hook_menu().
 *
 * Create admin page in order to change advice message.
 */
function fb_fan_menu() {

  $items = array();

  $items[FB_PATH_ADMIN . '/fb_fan/list'] = array(
    'title' => 'List Fan Boxes',
    'description' => '',
    'page callback' => 'fb_fan_admin_page_list',
    'access arguments' => array(FB_PERM_ADMINISTER),
    'file' => 'fb_fan.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  $items[FB_PATH_ADMIN . '/fb_fan/list/edit/%'] = array(
    'title' => 'Edit Fan Box',
    'access arguments' => array(FB_PERM_ADMINISTER),
    'weight' => 11,
    'type' => MENU_CALLBACK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fb_fan_edit_fanbox_form', TRUE),
  );

  $items[FB_PATH_ADMIN . '/fb_fan/delete/%'] = array(
    'title' => 'Delete Fan Box',
    'description' => '',
    'page callback' => 'fb_fan_admin_page_delete',
    'page arguments' => array(5),
    'access arguments' => array(FB_PERM_ADMINISTER),
    'file' => 'fb_fan.admin.inc',
    'type' => MENU_CALLBACK,
  );

  $items[FB_PATH_ADMIN . '/fb_fan/create'] = array(
    'title' => 'Add Fan Box',
    'access arguments' => array(FB_PERM_ADMINISTER),
    'weight' => 11,
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fb_fan_edit_fanbox_form'),
  );


  return $items;
}

/**
 * Form for create and editing fan box.
 */
function fb_fan_edit_fanbox_form($form, &$form_state, $is_edit = FALSE) {
  fb_fan_check_if_fb_application_exists();

  $fanboxes = variable_get('fb_fan_fanboxes', array());
  if ($is_edit && is_numeric(arg(6))) {
    drupal_set_title(t('Edit Fan Box'));
    $fanbox_id = arg(6);
  }
  elseif ($is_edit) {
    drupal_set_message('Wrong url. No id set in url.');
    return FALSE;
  }
  else {
    // Create page.
    drupal_set_title(t('Create Fan Box'));
    $fanbox_id = 'temp';
    $fanboxes[$fanbox_id] = array(
      'fb_fan_name' => '',
      'fb_fan_profile_id' => '',
      'fb_fan_connections' => '10',
      'fb_fan_width' => '200',
      'fb_fan_height' => '400',
      'fb_fan_css_path' => '',
      'fb_fan_stream' => '1',
      'fb_fan_logo' => '1',
      'fb_fan_header' => '1',
    );
  }

  $form['fb_fan_general_settings'] = array(
    '#title' => t('General Settings'),
    '#type' => 'fieldset',
    '#collapsible' => FALSE,
  );
  $form['fb_fan_general_settings']['is_edit'] = array(
    '#type' => 'hidden',
    '#required' => TRUE,
    '#default_value' => $is_edit ? '1' : '0',
  );
  $form['fb_fan_general_settings']['fb_fan_fanbox_id'] = array(
    '#type' => 'hidden',
    '#required' => TRUE,
    '#default_value' => $fanbox_id,
  );
  $form['fb_fan_general_settings']['fb_fan_name'] = array(
    '#title' => t('Name'),
    '#type' => 'textfield',
    '#size' => 45,
    '#maxlength' => 50,
    '#required' => TRUE,
    '#description' => t('Ex. My first fan box eng. This field is used to generate name for block.'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_name'],
  );
  $form['fb_fan_general_settings']['fb_fan_profile_id'] = array(
    '#title' => t('Profile ID'),
    '#type' => 'textfield',
    '#size' => 45,
    '#maxlength' => 50,
    '#required' => TRUE,
    '#description' => t('Ex. 208184621292. Go to https://graph.facebook.com/YOURPAGENAME to get the id.'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_profile_id'],
  );
  $form['fb_fan_general_settings']['fb_fan_connections'] = array(
    '#title' => t('Connection Amount'),
    '#type' => 'textfield',
    '#size' => 45,
    '#maxlength' => 50,
    '#required' => TRUE,
    '#description' => t('Number of fans to display'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_connections'],
  );
  $form['fb_fan_general_settings']['fb_fan_width'] = array(
    '#title' => t('Width'),
    '#type' => 'textfield',
    '#size' => 45,
    '#maxlength' => 50,
    '#required' => TRUE,
    '#description' => t('Width of the fan box'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_width'],
  );
  $form['fb_fan_general_settings']['fb_fan_height'] = array(
    '#title' => t('Height'),
    '#type' => 'textfield',
    '#size' => 45,
    '#maxlength' => 50,
    '#required' => TRUE,
    '#description' => t('Height of the fan box'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_height'],
  );
  $form['fb_fan_general_settings']['fb_fan_css_path'] = array(
    '#title' => t('CSS Path'),
    '#type' => 'textfield',
    '#size' => 45,
    '#maxlength' => 255,
    '#required' => FALSE,
    '#description' => t('Ex. http://example.com/style.css. If not set, PATH_TO_THEME/css/fb_fan.css will be used.'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_css_path'],
  );
  $form['fb_fan_general_settings']['fb_fan_stream'] = array(
    '#title' => t('Stream'),
    '#type' => 'checkbox',
    '#description' => t('Show postings from the Facebook page'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_stream'],
  );
  $form['fb_fan_general_settings']['fb_fan_logo'] = array(
    '#title' => t('Facebook Logo'),
    '#type' => 'checkbox',
    '#description' => t('Show the Facebook logo'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_logo'],
  );
  $form['fb_fan_general_settings']['fb_fan_header'] = array(
    '#title' => t('Facebook Header'),
    '#type' => 'checkbox',
    '#description' => t('Show the Facebook Header'),
    '#default_value' => $fanboxes[$fanbox_id]['fb_fan_header'],
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );
  return $form;
}

/**
 * Submit callback for creating and editing fan boxes.
 */
function fb_fan_edit_fanbox_form_submit($form, &$form_state) {
  $fanboxes = variable_get('fb_fan_fanboxes', array());
  if ($form['fb_fan_general_settings']['is_edit']['#value'] == '1') {
    // Get allready existing id.
    $fanbox_id = $form['fb_fan_general_settings']['fb_fan_fanbox_id']['#value'];
  }
  else {
    // Generate new id.
    if (count($fanboxes) == 0) {
      $fanbox_id = 0;
    }
    else {
      $fanbox_id = max(array_keys($fanboxes));
      $fanbox_id++;
    }
  }

  foreach ($form['fb_fan_general_settings'] as $item) {
    if (is_array($item) && isset($item['#type']) && $item['#type'] !='hidden') {
      $fanboxes[$fanbox_id][$item['#name']] = $item['#value'];
      print_r($fanbox_id);
    }
  }
  variable_set('fb_fan_fanboxes', $fanboxes);
  if ($form['fb_fan_general_settings']['is_edit']['#value'] == '1') {
    drupal_set_message(t('Fanbox changed.'));
  }
  else {
    drupal_set_message(t('Fanbox added.'));
  }
  drupal_goto(FB_PATH_ADMIN . '/fb_fan/list');
}

/**
 * Implements of hook_block_info().
 */
function fb_fan_block_info() {
  $fanboxes = variable_get('fb_fan_fanboxes', array());
  $blocks = array();
  foreach ($fanboxes as $id => $fanbox) {
    $blocks['fb_fan_' . $id] = array(
      'info' => $fanbox['fb_fan_name'],
      'cache' => DRUPAL_CACHE_GLOBAL,
    );
  }
  return $blocks;
}

/**
 * Implements of hook_block_view().
 */
function fb_fan_block_view($block_name = '') {
  $fanboxes = variable_get('fb_fan_fanboxes', array());
  foreach ($fanboxes as $id => $fanbox) {
    if ($block_name == 'fb_fan_' . $id) {
      $css = strlen($fanbox['fb_fan_css_path']) ? $fanbox['fb_fan_css_path'] : FALSE;
      $cache_css = variable_get('fb_fan_cache_css', '0');
      $random = '?' . rand(1, 1000000);
      if (!$css) {
        if (file_exists(path_to_theme() . '/css/fb_fan.css')) {
          $css = 'http://' . $_SERVER['HTTP_HOST'] . '/' . path_to_theme() . '/css/fb_fan.css' . ($cache_css === '0' ? $random : '');
        }
      }
      elseif ($cache_css == '0') {
        $css .= $random;
      }
      $attributes_array = array(
        'profile_id' => $fanbox['fb_fan_profile_id'],
        'stream' => $fanbox['fb_fan_stream'],
        'connections' => $fanbox['fb_fan_connections'],
        'logobar' => $fanbox['fb_fan_logo'],
        'header' => $fanbox['fb_fan_header'],
        'width' => $fanbox['fb_fan_width'],
        'height' => $fanbox['fb_fan_height'],
      );
      $attr = '';
      foreach ($attributes_array as $key => $var) {
        $attr .= $key . '="' . $var . '" ';
      }

      $content = '<fb:fan show_faces="true" ' . $attr . ($css ? 'css="' . $css . '" ' : '') . '></fb:fan>';

      $block = array(
        'subject' => t('Facebook Fan Box'),
        'content' => $content,
      );
      return $block;
    }
  }
}

/**
 * Implements of hook_form_alter().
 */
function fb_fan_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'fb_admin_settings') {
    $form['fb_fan_general_settings'] = array(
      '#title' => t('Facebook Fan Box Settings'),
      '#type' => "fieldset",
      '#collapsible' => TRUE,
    );
    $form['fb_fan_general_settings']['fb_fan_cache_css'] = array(
      '#title' => t('Cache CSS'),
      '#type' => "checkbox",
      '#description' => t("Turn this on by default. For development is good to disable caching."),
      '#default_value' => variable_get('fb_fan_cache_css', '0'),
    );
  }
}

/**
 * Show warning message if no Facebook application hasn't been created.
 */
function fb_fan_check_if_fb_application_exists() {
  $apps = fb_get_all_apps();
  if (count($apps) == 0) {
    drupal_set_message(t("Fan Boxes need Facebook application. Don't forget to !create one!", array('!create' => l(t('create'), FB_PATH_ADMIN . '/fb_app_create'))), 'warning');
  }
}
